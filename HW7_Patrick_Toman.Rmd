---
title: "STAT 5361 -  HW 7"
author: Patrick Toman^[<patrick.toman@uconn.edu>; Ph.D. student at Department of Statistics,
  University of Connecticut.]
date: "`r format(Sys.time(), '%d %B %Y')`"
output: pdf_document
header-includes:
  - \usepackage[ruled,vlined,linesnumbered]{algorithm2e}
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE,message = F)
```

```{r,echo=FALSE,message=FALSE}
rm(list=ls())
library(tidyverse)
```



# Problem 5.3.1 

## Part (i)

\begin{align*}
  1 & = C \left[\int_{0}^{\infty} 2x^{\theta-1}e^{-x}dx + \int_{0}^{\infty} x^{\theta-1/2}e^{-x}dx \right] \\
    & = C \left[ 2\Gamma(\theta) + \Gamma(\theta + 1/2) \right]
\end{align*}

Therefore, we can re-arrange terms to find that

\begin{equation*}
  C = \frac{1}{2\Gamma(\theta) + \Gamma(\theta + 1/2)}
\end{equation*}

Furthermore, let us denote 

\begin{align*}
  h_1(x) & = x^{\theta-1}e^{-x} , \ I(x>0) \\
  h_2(x) & = x^{\theta-1/2}e^{-x} , \ I(x>0)
\end{align*}

Clearly, these two functions correspond the kernel of two gamma densities, namely $Gamma(\theta,1)$ and $Gamma(\theta+1/2,1)$. Therefore, we derive our full pdf for $g(x)$ as

\begin{align*}
  g(x) & = \left(\frac{2 \Gamma(\theta) x^{\theta-1}e^{-x}}{\Gamma(\theta)(2\Gamma(\theta) + \Gamma(\theta + 1/2))} + \frac{\Gamma(\theta+1/2)x^{\theta-1/2}e^{-x}}{\Gamma(\theta + 1/2)(2\Gamma(\theta) + \Gamma(\theta + 1/2))}\right)
\end{align*}

Thus, we conclude that $g(x)$ is a mixture of gammas with the following mixing proportions

\begin{align*}
  \pi_1 & = \frac{2\Gamma(\theta)}{2\Gamma(\theta) + \Gamma(\theta+1/2)} \\ 
  \pi_2 & = \frac{\Gamma(\theta + 1/2)}{2\Gamma(\theta) + \Gamma(\theta+1/2)}\\
  & \text{Subject to} \  \pi_1 + \pi_2 = 1
\end{align*}

\newpage

## Part (ii) 

The following pseudo-code details how to draw from our gamma mixture in part(i).

### Pseudo-code

\begin{algorithm}[H]
\DontPrintSemicolon
\SetAlgoLined
\KwIn{$n =$ sample size,$\theta$ = user defined scale parameter}
\KwResult{$n$ Simulated Observations from density $g(x)$}
\BlankLine
Allocate empty vector $X \in \mathcal{R}^{n \times 1}$ \;
\For{$i \ \text{in} \ 1:n$}{
    Draw $U \sim Bernoulli\left(p = \frac{2 \Gamma(\theta)}{2 \Gamma(\theta) + \Gamma(\theta+1/2)}\right)$ \;
    \eIf{$U = 1$}{
        $X[i] \sim Gamma(\theta,1)$\;
    }{
        $X[i] \sim Gamma(\theta+\frac{1}{2},1)$\;
    }
}
\caption{Gamma Mixture Simulation}
\end{algorithm}

### Implementation


```{r,gamma_mix_sim}
my_gamma_mix_sim <- function(size,theta){
  
  X <- rep(NA,size)
  
  p <- 2*gamma(theta)/(2*gamma(theta) + gamma(theta+0.5))
  
  for(i in 1:size){
    
    U <- rbinom(1,1,p)
    
    if(U == 1){
      
      X[i] <- rgamma(1,shape = theta,rate=1)
      
    }else{
      
      X[i] <- rgamma(1,shape = theta+1/2,rate=1)
      
    }
    
  }
  
  return(X)
  
  
  
}
```



```{r,simulate}
set.seed(1022)

theta <- 3.25
my_simulated_gammamix <- my_gamma_mix_sim(size = 10000,theta=theta)

```

```{r,bmixture,echo=FALSE,include=F}
#simulated_gammamix <- bmixture::rmixgamma(n=10000,weight = c(p,1-p),
#                                          alpha = c(theta,theta+1/2),beta = rep(1,2)) 

#density_gammamix <- bmixture::dmixgamma(x=x,weight = c(p,1-p),
#                                        alpha = c(theta,theta+1/2),beta = rep(1,2)) 



#hist(simulated_gammamix,prob=T,nclass = 30,col = 'red')
#hist(my_simulated_gammamix,prob=T,nclass = 30,add=T,col = 'blue')
#lines(x,density_gammamix,type = 'l',lwd=3)
```


## Part (iii) - Rejection Sampling

The folling algorithm presents a rejection sampling scheme to draw samples from target density 

$$f(x) \propto \ \sqrt{4 + x}x^{\theta-1}e^{-x}, I(x>0)$$

using the following instrumental density

$$g(x) =   \left(\frac{2 \Gamma(\theta) x^{\theta-1}e^{-x}}{\Gamma(\theta)(2\Gamma(\theta) + \Gamma(\theta + 1/2))} + \frac{\Gamma(\theta+1/2)x^{\theta-1/2}e^{-x}}{\Gamma(\theta + 1/2)(2\Gamma(\theta) + \Gamma(\theta + 1/2))}\right)$$

### Pseudo-code

\begin{algorithm}[H]
\DontPrintSemicolon
\SetAlgoLined
\KwIn{$n =$ sample size,$\theta$ = user defined scale parameter,$\alpha \ge 0$ = user defined constant}
\KwResult{$n$ Simulated Observations from density $g(x)$}
\BlankLine
Allocate empty vector $X \in \mathcal{R}^{n \times 1}$ \;
\For{$i \ \text{in} \ 1:n$}{
    Draw $U \sim Bernoulli\left(p = \frac{2 \Gamma(\theta)}{2 \Gamma(\theta) + \Gamma(\theta+1/2)}\right)$ \;
    \eIf{$U = 1$}{
        $X[i] \sim Gamma(\theta,1)$\;
    }{
        $X[i] \sim Gamma(\theta+\frac{1}{2},1)$\;
    }
}
\caption{Rejection Sampler}
\end{algorithm}


### Implementation


```{r,rejection_sampling}

gy <- function(y,theta){(2*y^(theta-1) + y^(theta-1/2))*exp(-y)}

fy <- function(y,theta){sqrt(4+y)*y^(theta-1)*exp(-y)}

rejection_sampler <- function(n,theta,alpha){
  
  X <- rep(NA,n)
  
  p <- 2*gamma(theta)/(2*gamma(theta) + gamma(theta+0.5))
  
  accepted_ct <- 0 
  
  rejected_ct <- 0 
  
  i <- 1 
  
  while(accepted_ct < n){
    
    y <- my_gamma_mix_sim(size=1,theta=theta)
    
    gy <- gy(y=y,theta=theta)
    
    fy_set <- fy(y=y,theta=theta)
    
    U <- runif(1,0,1)
    
    if(U < fy_set/(alpha*gy)){
      
      X[i] <- y
      
      i <- i + 1
      
      accepted_ct <- accepted_ct + 1
      
    }else{
      
      rejected_ct <- rejected_ct + 1
      
    }
  
  }
  
  return(list('Sample'=X,'RejectCt'=rejected_ct))
}

```

```{r,densities,include=F,echo=F}
#gy_density <- gy(y=x,theta=theta)
#fy_density <- fy(y=seq(0,20,length.out = 10000),theta=theta)

#plot(gy_density,type='l',col='blue')
#lines(fy_density,type = 'l',col='red')

#curve(sqrt(4+x)*x^(theta-1)*exp(-x),from = 0.001,to=15)

```

```{r,rejection_sample_test}

n <- 10000

rejection <- rejection_sampler(n=n,theta = theta,alpha=3)
fy_density <- fy(y=seq(0,20,length.out = 10000),theta=theta)


plot_df <- cbind.data.frame('Length'=seq(0,20,length.out = 10000),'RejectionSample'=rejection$Sample,'Target'=fy_density)

plot_df %>% 
  ggplot()+
  geom_density(aes(x=RejectionSample))+
  ylab('Density') + xlab('y') + 
  ggtitle('Estimated Density')+
  theme_minimal() -> plt_estimated_density

plot_df %>% 
  ggplot()+
  geom_line(aes(x=Length,y=Target))+
  theme_minimal() + ylab('f(y)') + xlab('y') +
  ggtitle('Target Density (Un-normalized)') -> plt_true_density

gridExtra::grid.arrange(plt_estimated_density,plt_true_density, ncol=2)


```

# Problem 6.3.1 

$\pi(\mu_1),\pi(\mu_2)\sim N(0,\tau^2 = 10^2)$ and $\pi(1/\sigma^2_1) \sim \Gamma(a,b)$


```{r}

delta <- 0.7 # true value to be estimated based on the data
n <- 100
set.seed(123)
u <- rbinom(n, prob = delta, size = 1)
x <- rnorm(n, ifelse(u == 1, 7, 10), 0.5)

```
